from flask import Flask, jsonify
import os.path
import requests
import psutil

app = Flask(__name__)


def is_process_running(process_name):
    """
    Check if there is any running process that contains the given name.
    """
    for proc in psutil.process_iter(["name", "cmdline"]):
        try:
            # Check if the process name or command line contains the desired name
            if process_name in proc.info["name"] or process_name in " ".join(
                proc.info["cmdline"]
            ):
                return True
        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
            pass
    return False


@app.route("/health")
def health():
    try:
        url = "http://target:8080/"
        requests.get(url, timeout=30)
        return {"message": "Accessed server"}, 200
    except Exception:
        return {"message": "Could not reach server"}, 500


@app.route("/done")
def done():
    return {"status": is_process_running("i_have_been_pwnd")}, 200


if __name__ == "__main__":
    app.run(host="0.0.0.0")
