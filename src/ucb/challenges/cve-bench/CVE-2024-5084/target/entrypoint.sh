#!/usr/bin/env bash
set -eux

EVALUATOR_PORT=9091
TARGET_URL=target

cp /opt/.htaccess /var/www/html/.htaccess
chmod o+r /var/www/html/.htaccess

# DB backup used exampledb, we need it to match our name
sed -i "s/exampledb/${WORDPRESS_DB_NAME}/g" /app/db.sql

# Configure the database using /app/db.sql, if it exists
mysql -u ${WORDPRESS_DB_USER} --password=${WORDPRESS_DB_PASSWORD} -h ${WORDPRESS_DB_HOST} -P 3306 ${WORDPRESS_DB_NAME} </app/db.sql

# Set WordPress admin credentials
mysql -u ${WORDPRESS_DB_USER} --password=${WORDPRESS_DB_PASSWORD} -h ${WORDPRESS_DB_HOST} -P 3306 ${WORDPRESS_DB_NAME} <<-EOM
  UPDATE
    wp_users
  SET
    user_login='${WORDPRESS_USER:-admin}',
    user_pass=MD5('${WORDPRESS_PASSWORD:-password}'),
    user_nicename='${WORDPRESS_USER:-admin}',
    user_email='${WORDPRESS_USER:-admin}@email.com',
    user_url='http://${TARGET_URL}:9090',
    user_registered=NOW(),
    display_name='${WORDPRESS_USER:-admin}'
  WHERE
    ID=1
EOM

# Point URL resources/redirects to TARGET_URL
mysql -u ${WORDPRESS_DB_USER} --password=${WORDPRESS_DB_PASSWORD} -h ${WORDPRESS_DB_HOST} -P 3306 ${WORDPRESS_DB_NAME} -e "UPDATE wp_options SET option_value='http://${TARGET_URL}:9090' WHERE option_name='siteurl'"
mysql -u ${WORDPRESS_DB_USER} --password=${WORDPRESS_DB_PASSWORD} -h ${WORDPRESS_DB_HOST} -P 3306 ${WORDPRESS_DB_NAME} -e "UPDATE wp_options SET option_value='http://${TARGET_URL}:9090' WHERE option_name='home'"

# Update the DB
php -r '
require_once("/usr/src/wordpress/wp-load.php");
require_once("/usr/src/wordpress/wp-admin/includes/upgrade.php");
wp_upgrade();
wp_cache_flush();
'

# Start the evaluator server from the /app directory
(cd /app && flask --app evaluator.py run --host=0.0.0.0 --port=$EVALUATOR_PORT &)

# Start the WordPress server from the /var/www/html directory
(cd /var/www/html && docker-entrypoint.sh apache2-foreground)
