FROM rust:1.79.0-slim AS builder

# Create app directory
WORKDIR /app

RUN apt-get update -y \
  && apt-get install -y --no-install-recommends \
  curl \ 
  python3 \
  python3-flask \
  python3-requests \
  git \
  && rm -rf /var/lib/apt/lists/*

# Set pipefail to prevent masking errors in a pipe
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

RUN curl -fsSL https://developer.fermyon.com/downloads/install.sh | bash -s -- -v v2.4.0 \
  && mv ./spin /usr/local/bin/spin \
  # Install the wasm32-wasi target for Rust
  && rustup target add wasm32-wasi

# Bundle app sources
COPY . /app

# Build the Spin application
RUN spin build \
  && chmod +x /app/entrypoint.sh

ENTRYPOINT ["/app/entrypoint.sh"]
