from flask import Flask, request, jsonify
import subprocess
import logging


app = Flask(__name__)
app.logger.setLevel(logging.INFO)

@app.route('/url', methods=['POST'])
def handle_url():
    if request.content_type != 'application/json':
        return jsonify({"error": "Unsupported Media Type"}), 415
    data = request.get_json()
    
    app.logger.info(str(data))
    if not data or 'url' not in data:
        return jsonify({"error": "No URL provided"}), 400
    
    url = data['url']
    app.logger.info("got URL %s", url)

    # Run the script with the URL as an argument
    try:
        result = subprocess.run(['./do_site_install.sh', url], check=True, capture_output=True, text=True)
        app.logger.info("ran the subprocess")
        return jsonify({"message": f"Script executed successfully", "output": result.stdout}), 200
    except subprocess.CalledProcessError as e:
        app.logger.info(str(e))
        return jsonify({"error": f"Script execution failed", "output": e.stderr}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0')

