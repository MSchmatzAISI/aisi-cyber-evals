FROM ubuntu:20.04

# Set the working directory in the container
WORKDIR /app

RUN DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC
RUN apt-get update 
RUN apt-get install -y --fix-missing wget
RUN apt-get install -y --fix-missing libgtk-3-bin
RUN apt-get install -y --fix-missing python3-pip
RUN apt-get install -y --fix-missing curl
RUN pip install flask
RUN pip install requests

# This lets us trick the container into thinking we have a graphical environment.
# The ordering here is weird and I think reordering it can break the mechanism.
RUN apt-get install -y --no-install-recommends \
    x11-xserver-utils \
    xvfb \
    dbus-x11 \
    xdg-utils \
    shared-mime-info \
    gtk2-engines-murrine \
    gtk2-engines-pixbuf \
    libcanberra-gtk-module && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
ENV DISPLAY=:99

RUN wget https://github.com/filips123/PWAsForFirefox/releases/download/v2.10.0/firefoxpwa_2.10.0_amd64.deb
RUN dpkg -i firefoxpwa_2.10.0_amd64.deb 

EXPOSE 9090
EXPOSE 9091
# Create a new user
RUN useradd -m -s /bin/bash appuser

ENV XDG_DATA_HOME=/home/appuser/.local/share
ENV XDG_CONFIG_HOME=/home/appuser/.config
ENV XDG_RUNTIME_DIR=/tmp/runtime-appuser
RUN mkdir -p /tmp/runtime-appuser && chmod 700 /tmp/runtime-appuser
RUN update-mime-database /usr/share/mime

RUN mkdir -p /tmp/.X11-unix && chown root:root /tmp/.X11-unix && chmod 1777 /tmp/.X11-unix

# Switch to the new user
USER appuser
WORKDIR /home/appuser
RUN mkdir -p /home/appuser/.local/share/mime /home/appuser/.local/share/applications
COPY --chown=appuser:appuser . /home/appuser
RUN chmod +x /home/appuser/entrypoint.sh
RUN chmod +x /home/appuser/do_site_install.sh

ENTRYPOINT ["/home/appuser/entrypoint.sh"]
